<br/>

>[!NOTE|style: flat|label: ç®€è¦è¯´æ˜ ]
>
>åŸºäº[ å…³ç³»å‹æ•°æ®åº“ ]çš„é…ç½®æº  [`namespaceï¼šZack.AnyDBConfigProvider`] [<span style='color:#008B00'>[ğŸ‘“ NuGet - Zack.AnyDBConfigProvider ]</span>](https://github.com/yangzhongke/Zack.AnyDBConfigProvider/blob/main/README_CHS.md ':target=_blank') 
>
>- å»ºç«‹è¡¨ç»“æ„`ConfigurationSource`
>
>  ```shell
>  mysql> show create table ConfigurationSource;
>  
>  #+---------------------+-------------------------------------------------+
>  #| Table               | Create Table                                    |
>  #+---------------------+-------------------------------------------------+
>  #| ConfigurationSource | CREATE TABLE `ConfigurationSource` (
>  #
>  #      `id` int NOT NULL AUTO_INCREMENT,
>  #      `Name` varchar(50) DEFAULT NULL,
>  #      `Value` varchar(500) DEFAULT NULL,
>  #       PRIMARY KEY (`id`)
>  #
>  #  ) ENGINE = InnoDB 
>  #+---------------------+-------------------------------------------------+
>  
>  
>  ```
>
>  <br/>



<!-- tabs:start -->

#### **DBConfigurationSource**

```csharp
//[ é…ç½®é¡¹ ]æ•°æ®åº“
public class DBConfigOptions
{
    
      public Func<IDbConnection> CreateDbConnection { get; set; }
      public string TableName { get; set; } = "T_Configs";
    
      public bool ReloadOnChange { get; set; } = false; //æ˜¯å¦å˜æ›´ç›‘æ§
      public TimeSpan? ReloadInterval { get; set; }     //[ å‘ç”Ÿå˜æ›´å ]å»¶è¿ŸåŠ è½½é…ç½®(æ¯«ç§’)
    
}


```



```csharp
public class DBConfigurationSource : IConfigurationSource
{
    
	  private DBConfigOptions options;
     
	  public DBConfigurationSource(DBConfigOptions options) => this.options = options;
	  public IConfigurationProvider Build(IConfigurationBuilder builder) => new DBConfigurationProvider(options);
    
}


```



#### **DBConfigurationProvider**

```csharp
public class DBConfigurationProvider : ConfigurationProvider, IDisposable
{

	  private DBConfigOptions options;

	  //[ çº¿ç¨‹å®‰å…¨ ]è¯»å†™é”
	  private ReaderWriterLockSlim lockObj = new ReaderWriterLockSlim();
	  private bool isDisposed = false;
    
	  public DBConfigurationProvider(DBConfigOptions options)
	  {

		    this.options = options;

		    //æ˜¯å¦å˜æ›´ç›‘æ§
		    if (options.ReloadOnChange)
		    {
			      //å»¶è¿Ÿæ—¶é—´
			      TimeSpan interval = TimeSpan.FromSeconds(3);
			      if (options.ReloadInterval != null) interval = options.ReloadInterval.Value;

			      ThreadPool.QueueUserWorkItem(obj => {
					   while (!isDisposed)
					   {
						    this.Load();
						    Thread.Sleep(interval);
					   }
			      });
		    }

	  }

	  public override void Load()
	  {
          
		    //[ A ]è®°å½•åŸå§‹æ•°æ®
		    IDictionary<string, string> clonedData = base.Data.Clone();
		    base.Data.Clear();

		    try {
			    
                 lockObj.EnterWriteLock();

			     string tableName = options.TableName;
			     using (IDbConnection conn = options.CreateDbConnection())
			     {
                       //[ B ]è¯»å–æœ€æ–°é…ç½®
					   conn.Open();
					   using (IDbCommand cmd = conn.CreateCommand())
					   {
						    cmd.CommandText = $"select Name,Value from {tableName} where Id in(select Max(Id) from {tableName} group by Name)";
						    using (var reader = cmd.ExecuteReader())
						    {
							     while (reader.Read())
							     {
								      string name = reader.GetString(0);
								      string value = reader.GetString(1);
								      base.Data[name] = value;
							     }
						    }
					   }
			     }

		    }
		    catch (DbException) { throw; }
		    finally { lockObj.ExitWriteLock(); }

		    //[ C ]å¯¹æ¯”å†å²æ•°æ®æ˜¯å¦å˜åŠ¨
		    if (Helper.IsChanged(clonedData, base.Data))
		    {
			     base.OnReload();
		    }

	  }

	  public override IEnumerable<string> GetChildKeys(IEnumerable<string> earlierKeys, string parentPath)
	  {
		   lockObj.EnterReadLock();
		   try { return base.GetChildKeys(earlierKeys, parentPath); }
		   finally { lockObj.ExitReadLock(); }
	  }

	  public override bool TryGet(string key, out string value)
	  {
		   lockObj.EnterReadLock();
		   try { return base.TryGet(key, out value); } finally { lockObj.ExitReadLock(); }
	  }

	  public void Dispose() { this.isDisposed = true; }

}


```



#### **DBConfigurationProviderExtensions**

```csharp
public static class DBConfigurationProviderExtensions
{
    
      public static IConfigurationBuilder AddDbConfiguration(this IConfigurationBuilder builder, DBConfigOptions Options)
          => builder.Add(new DBConfigurationSource(Options));

      public static IConfigurationBuilder AddDbConfiguration(this IConfigurationBuilder builder, 
                                                             Func<IDbConnection> createDbConnection, 
                                                             string tableName= "T_Configs",
                                                             bool reloadOnChange = false,
                                                             TimeSpan? reloadInterval = null)
      {
          
            DBConfigOptions Options = new DBConfigOptions {
                
                CreateDbConnection = createDbConnection,
                TableName = tableName,
                
                ReloadOnChange = reloadOnChange,
                ReloadInterval = reloadInterval
                
            };
            return AddDbConfiguration(builder, Options);
            
      }
    
}


```



<!-- tabs:end -->

```csharp
var source = new Dictionary<string, string>
{

	 ["ConnectionStrings:Con1"] = "Server=192.168.0.7;database=MyTest;uid=root;pwd=888888",
	 ["ConnectionStrings:Con2"] = "Server=127.0.0.1;database=youzack;uid=root;pwd=123456",

};
IConfigurationRoot root = new ConfigurationBuilder()
							 .AddInMemoryCollection(source)
							 .Build();
string connStr = root.GetConnectionString("Con1");


IConfigurationRoot dbRoot = new ConfigurationBuilder()
							   .AddDbConfiguration(
    								() => new MySqlConnection(connStr), 
    							    tableName: "ConfigurationSource", 
    								reloadOnChange: true, 
    								reloadInterval: TimeSpan.FromSeconds(2))
							   .Build();
Console.WriteLine(dbRoot.GetRequiredSection("Name").Value);

ChangeToken.OnChange(() => dbRoot.GetReloadToken(), () => {
	 Console.WriteLine(dbRoot.GetRequiredSection("Name").Value);
});


```

